# 模型文档

## 1. 模型目标

本项目旨在根据历史气象数据和污染物浓度，预测未来一天的空气质量指数（AQI）。模型输入为当日及前几天的气象要素、城市地理特征和时间特征，输出为多种污染物的 24 小时平均浓度预测值（PM2.5、PM10、O3、NO2、SO2、CO），再根据各污染物的浓度计算对应的 AQI 值。

### 1.1 多城市统一建模策略

不同地区的天气与空气质量关系存在显著差异。影响因素包括：地理位置和气候带不同导致的基础气象条件差异；污染源结构和排放强度不同导致污染物背景浓度不同；地形条件影响污染物扩散和传输；城市规划和土地利用影响局地气象特征。本项目采用多城市统一建模策略，通过在模型中加入城市地理特征（海拔、地形、沿海标记、气候带）来区分不同城市的特性，从而在单一模型中捕捉各地差异化的"天气-污染"关系模式。

### 1.2 多污染物联合建模

不同污染物的形成机制和对气象条件的响应各不相同。PM2.5 主要受二次生成、燃烧排放和气象扩散条件影响；臭氧是光化学反应产物，与前体物浓度和光照条件密切相关；NO2、SO2、CO 各有其特定的来源和化学转化过程。本项目采用多输出回归模型，同时预测多种污染物的浓度。这种方式可以建模污染物之间的相关性，共享底层特征表示，提高模型的泛化能力。

### 1.3 探索性数据分析 (EDA)

在建模之前，必须对数据进行深入的探索性分析，以指导特征工程和模型选择。EDA 过程将包含代码实现并重点关注以下方面：

*   **数据分布分析**：检查目标变量（各污染物浓度）的分布形态，识别偏态和峰度。如果分布严重偏斜，需进行对数转换或 Box-Cox 转换，以符合某些模型的正态假设。
*   **相关性分析**：
    *   **气象-污染相关性**：计算各气象要素（如风速、降水、温度）与污染物浓度之间的 Pearson 或 Spearman 相关系数，验证物理规律（如降水对 PM2.5 的清除作用）。
    *   **时序自相关性**：绘制自相关图 (ACF) 和偏自相关图 (PACF)，确定最佳滞后阶数（Lag N），为滞后特征的构建提供依据。
*   **时序分解**：使用 STL (Seasonal-Trend decomposition using LOESS) 方法将时间序列分解为趋势项、季节项和残差项。识别是否存在明显的年度、季度或周度周期性，指导时间特征的设计。
*   **地理空间分析**：对比不同城市的气象和污染特征分布。通过箱线图或小提琴图展示各城市污染物浓度的中位数和波动范围，验证引入地理和历史统计特征的必要性。

## 2. 特征选择

### 2.1 气象特征

气象因素对空气质量有直接影响。根据 EPA 的研究，温度、降水、风速、气压等气象条件会影响污染物的生成、扩散和清除过程。从 NOAA GSOD 数据中提取的气象特征包括：日平均温度、最高温度、最低温度、露点温度、日降水量、平均风速、海平面气压和能见度。

### 2.2 时间特征

污染物的浓度和组成具有明显的周期性变化规律，反映了人类活动模式和自然环境周期。将日期转换为一年中的第几天，然后使用正弦和余弦函数进行周期性编码。这种编码方式能够保证跨年日期的连续性，例如 12 月 31 日和 1 月 1 日在编码空间中相近。月份也可以采用类似的编码方式，以捕捉月度变化规律。星期几作为辅助特征，用于检测工作日与周末的差异。

### 2.3 滞后特征

污染物具有累积效应和时序依赖关系。静稳天气条件下，污染物会在大气中持续累积，导致浓度逐渐升高。因此，创建前 1 到 7 天的滞后特征，包括滞后 1 到 7 天的温度、降水和各类污染物（PM2.5、PM10、O3、NO2、SO2、CO）浓度。这些滞后特征帮助模型学习历史天气状况和历史污染水平对当日空气质量的影响。

### 2.4 滚动统计特征

计算各类污染物（PM2.5、PM10、O3、NO2、SO2、CO）过去 7 天的滚动平均值和滚动标准差。滚动均值反映近期整体趋势，可用于判断近期空气质量是处于改善还是恶化阶段。滚动标准差反映近期波动程度，高波动可能预示着即将到来的变化。这些统计特征综合反映了各污染物的近期动态。

### 2.5 静态城市特征 (Static City Features)

为了在统一模型中有效区分不同城市的特性，我们将重点构建以下三类静态特征，以替代难以实时获取的动态社会经济数据：

**1. 地理特征 (Geographic Features)**
*   **经纬度 (Lat/Lon)**：直接反映城市在全球的绝对位置，隐含了太阳辐射角度、气候带等信息。
*   **海拔高度 (Elevation)**：以米为单位，直接影响大气压力和氧气浓度。高海拔城市通常气压较低，污染物扩散条件与低海拔城市存在系统性差异。
*   **距海距离 (Distance to Coast)**：计算城市中心到最近海岸线的距离。这对于捕捉海洋性气候调节、海陆风循环（对污染物扩散至关重要）具有决定性作用。
*   **地形类型与气候带**：作为辅助的分类特征，标记城市所属的宏观地理环境（如平原、盆地）和气候类型。

**2. 历史统计特征 (Historical Statistical Features)**
利用过去一年的历史数据计算城市的“污染指纹”，作为静态特征输入模型：
*   **年度污染基线**：计算该城市过去一年 PM2.5 的平均浓度。这反映了城市的长期背景污染水平（例如，工业城市基线通常高于旅游城市）。
*   **季节性波动强度**：计算不同季节的浓度方差，反映城市受季节变化影响的敏感度。

**3. 人口特征 (Demographic Features)**
*   **人口规模 (Population Size)**：城市人口是对经济活动总量和潜在排放规模的强力代理。对人口数进行对数变换后输入模型，帮助模型学习“大城市”与“小城市”在污染模式上的系统性偏差。

### 2.7 社会经济特征 (TBD)

*此部分标记为 **TBD (To Be Determined)**。*
*在原型验证阶段，暂不纳入详细的经济发展水平、产业结构、交通模式和能源结构等特征。这些特征虽然有助于捕捉排放背景的差异，但数据获取和标准化的时间成本较高。后期将视模型优化的边际收益决定是否引入。*

### 2.8 特征重要性分析

通过相关性分析和模型特征重要性评估，识别对预测最有价值的特征。气象因素如温度、风速、降水量通常具有较高重要性。时间特征的贡献相对稳定。滞后特征中，近期滞后（如 lag-1、lag-2）的权重通常高于远期滞后。滚动均值特征对捕捉趋势非常有效。地理特征和历史统计特征可以帮助模型区分不同城市的排放背景，使模型能够泛化到未见过的城市或更好地适应不同城市的特性。

## 3. 实验设计

### 3.1 基准实验

为评估不同特征组合的贡献，设计一系列递进的基准实验。基准实验从最简单的特征集开始，逐步添加各类特征，比较模型性能的变化。

- **实验一 (Weather Only)**：使用当日气象特征进行同日预测。这是最简单的基准模型，仅依赖当日气象条件预测当日各污染物浓度。
- **实验二 (+ Time)**：在基准基础上添加时间周期特征（Day of Year Sin/Cos, Weekday），评估季节性和周期性对预测的帮助。
- **实验三 (+ Lag-1)**：进一步添加 lag-1 特征（前一天的气象和污染数据），考察前一天数据对预测的增量价值。
- **实验四 (+ Lag-7 & Rolling)**：添加 lag-7 特征和 7 天滚动统计特征（均值、标准差），评估更长时间跨度历史信息和趋势信息的贡献。
- **实验五 (+ Static Features)**：添加地理特征（经纬度、海拔、距海距离）、历史统计特征（年度基线）和人口特征，评估引入城市静态差异信息对多城市统一建模的贡献。这是本次原型的**完整特征集**。
- **实验六 (TBD - Socio-economic)**：*（待定）添加更多细粒度的社会经济特征（如人均GDP、产业结构），评估人类活动因素的额外贡献。*

### 3.3 历史统计特征贡献实验

为验证“利用历史统计特征捕捉城市差异”这一策略的有效性，设计专门的消融实验（Ablation Study）。

- **Control Group**: 使用特征集 [气象 + 时间 + 滞后 + 滚动 + 地理坐标]。
- **Test Group**: 在 Control Group 基础上增加 [年度污染基线, 季节性波动强度]。

如果 Test Group 的 RMSE 显著低于 Control Group（例如下降 > 2%），则说明显式地告诉模型该城市的“历史背景”比让模型仅通过坐标去隐含学习更为有效。这将验证我们替代社会经济特征策略的正确性。

### 3.4 城市-污染物模型与城市-多污染物模型对比

在完成基准实验后，进行城市-污染物模型与城市-多污染物模型的对比实验，验证多输出建模策略的有效性。

城市-污染物模型（City-Pollutant Model）为每个城市-污染物组合单独训练一个模型。这种方式可以针对各地差异化的"天气-污染"关系进行精细化建模，但模型数量较多（城市数 × 污染物数），维护成本较高。

城市-多污染物模型（City-Multi-Pollutant Model）使用单一模型同时预测多种污染物。通过在模型中加入城市地理特征来区分不同城市的特性，并利用多任务学习共享底层特征表示。这种方式可以建模污染物之间的相关性，减少模型数量，但可能无法充分捕捉各地非常个性化的污染模式。

实验设计如下：首先为每个城市训练 PM2.5 的单独模型，获取基准性能指标；然后使用城市-多污染物模型在相同数据上进行训练，对比各污染物的预测性能变化。如果城市-多污染物模型性能下降在可接受范围内（如 RMSE 上升不超过 10%），则说明多输出策略可行，可以采用该方案以降低维护成本。

### 3.5 模型对比实验

在确定最优特征组合后，使用多种机器学习模型进行对比实验。传统统计模型包括线性回归、岭回归、Lasso 回归和弹性网络回归，这些模型简单高效，适合作为基准参考。集成学习模型包括随机森林和梯度提升树，具有较强的非线性建模能力和特征自动选择能力。神经网络模型使用多层感知机，能够学习复杂的特征交互关系。支持向量机回归在中小规模数据上表现良好。

### 3.6 AutoGluon 自动机器学习实验

利用 AutoGluon 自动机器学习框架进行模型选择和超参数优化。AutoGluon 可以同时训练多个模型并自动进行集成，根据时间限制自动分配计算资源。框架会自动处理特征工程、模型选择和超参数调优等步骤，输出最优模型的集成结果。实验中将比较 AutoGluon 自动选择的模型与手动调优模型的性能差异。

## 4. 模型训练

### 4.1 时间序列交叉验证

由于数据具有时间序列特性，采用时间序列交叉验证方法评估模型性能。不同于普通的 K 折交叉验证，时间序列验证严格保持时间顺序，每次使用较早时间段的数据训练，用较晚时间段的数据验证。这种方法避免了未来信息泄露，确保评估结果具有实际参考价值。

### 4.2 超参数调优

使用网格搜索或贝叶斯优化方法进行超参数调优。针对不同模型设置相应的超参数搜索空间：随机森林需要调优树的数量、最大深度和最小分裂样本数；梯度提升树需要调优学习率、树的数量和最大深度；岭回归需要调优正则化系数；神经网络需要调优隐藏层大小、学习率和迭代次数。

### 4.3 模型保存与版本管理

训练完成后保存模型及其元数据，包括训练日期、使用特征列表、模型类型和超参数配置。建立模型版本管理机制，记录每次实验的配置和结果，便于后续比较和复现。

## 5. 模型评估

### 5.1 评估指标

回归模型的评估使用以下指标，需分别对各污染物（PM2.5、PM10、O3、NO2、SO2、CO）计算。均方根误差（RMSE）是预测误差平方的平方根，对大误差敏感，用于衡量整体预测偏差程度。平均绝对误差（MAE）是预测误差绝对值的平均，对异常值更加稳健。决定系数（R²）表示模型解释目标变量变异的能力，取值范围为 0 到 1，越接近 1 表示拟合越好。平均绝对百分比误差（MAPE）是预测误差占实际值比例的平均，以百分比形式表示，便于理解预测精度。综合评分可采用各污染物指标的平均值或加权平均值。

### 5.2 残差分析

对模型预测残差进行系统性分析，评估模型假设的有效性。残差分布应接近正态分布且均值为零，如果存在明显偏态或峰度，说明模型假设可能不成立。残差与预测值的关系应无明显模式，否则说明存在非线性关系未被捕捉。Q-Q 图用于检验残差的正态性。正态 Q-Q 图中数据点应大致落在对角线上。

### 5.3 预测值与真实值对比

绘制预测值与真实值的散点图，理想情况下所有点应落在对角线附近。对角线下方表示低估，上方表示高估。绘制时间序列对比图，展示模型在不同时间段的预测表现。关注极端值（高污染日）的预测准确性，这对实际应用尤为重要。

### 5.4 模型对比表

汇总各模型在测试集上的评估指标，形成对比表格。表格按 RMSE 升序排列，直观展示模型优劣。标注每个模型的特点和适用场景，便于后续选择。

## 6. AQI 计算

### 6.1 EPA AQI 标准

美国环境保护署（EPA）制定了空气质量指数的计算标准。PM2.5 24 小时平均浓度与 AQI 存在分段线性关系。AQI 在 0 到 50 之间表示良好，51 到 100 表示中等，101 到 150 表示对敏感人群不健康，151 到 200 表示不健康，201 到 300 表示非常不健康，301 到 500 表示有害。

### 6.2 AQI 计算方法

根据 EPA 提供的 breakpoints 表，对 PM2.5 浓度进行线性插值计算 AQI 值。首先确定 PM2.5 浓度落入哪个区间，然后根据该区间的上下限和对应的 AQI 上下限进行线性插值。如果污染物浓度超出最高区间，AQI 相应标记为最高等级。

### 6.3 多污染物 AQI 综合

当有多种污染物数据时，取各污染物计算出的 AQI 最大值作为综合 AQI。不同污染物的浓度水平可能处于不同的健康风险等级，综合 AQI 反映最不利情况下的空气质量状况。

## 7. 模型推理

### 7.1 单步预测

模型可用于预测单日的多种污染物浓度。输入城市及当日气象预报数据，经过特征工程处理后，输入训练好的模型进行预测。输出为多种污染物（PM2.5、PM10、O3、NO2、SO2、CO）的预测浓度，再分别计算对应的 AQI 值，最终返回综合 AQI（各污染物 AQI 的最大值）、各污染物 AQI 以及 AQI 类别（如良好、中等、不健康等）。

### 7.2 多步滚动预测

对于需要预测未来多天的场景，采用滚动预测方法。预测第一天的各污染物浓度后，将预测结果加入历史数据序列，用于生成第二天的滞后特征，以此类推。滚动预测会累积误差，长期预测的准确性通常会逐渐下降。多污染物输出的情况下，还需考虑各污染物之间可能存在的相关性对滚动预测的影响。

### 7.3 批量预测

模型支持对整个测试集进行批量预测，输出包含日期、城市、各污染物预测浓度、实际浓度（如果有）和对应 AQI 的结果表格。批量预测结果可用于生成报告、可视化分析和性能评估。

## 8. 模型服务化

### 8.1 模型持久化

将训练好的模型保存为持久化格式，便于后续加载使用。模型文件包含模型结构、参数和配置信息。配套保存特征工程配置，确保推理时使用相同的特征处理方式。

### 8.2 推理服务封装

将模型封装为可独立部署的推理服务。服务接收 JSON 格式的输入数据，经过预处理后调用模型进行预测，返回 JSON 格式的预测结果。服务可部署在云端或本地服务器，支持实时预测请求。

### 8.3 结果后处理

模型原始输出为多种污染物浓度预测值，后处理模块负责对各污染物分别计算 AQI 值、确定 AQI 类别、生成健康建议等。综合 AQI 取各污染物 AQI 的最大值。最终返回包含各污染物预测浓度、对应 AQI、综合 AQI、AQI 类别和健康建议的完整结果。
