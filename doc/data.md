# 数据文档

## 1. 城市选择

### 1.1 选择策略

为保证数据质量并快速验证原型效果，项目初期**专注于 3-5 个具有代表性的美国主要城市**作为研究对象。这些城市在 NOAA 和 OpenAQ 数据集中均有高质量、长时间序列的覆盖，能够最大限度减少数据源本身带来的不确定性。

**首选城市列表：**
1.  **New York (NY)**: 美国最大城市，典型的东海岸沿海大都市，四季分明。
2.  **Los Angeles (CA)**: 西海岸超大城市，受地形和交通排放影响显著，光化学烟雾问题典型。
3.  **Chicago (IL)**: 内陆平原/湖滨城市，受大湖效应影响，冬季寒冷，风速较大。
4.  **Houston (TX)**: 南部工业重镇，高温高湿，受工业排放和气候共同影响。
5.  **San Francisco (CA)**: 西海岸港口城市，受海洋调节和微气候影响明显。

*注：对全球其他国际大都市的研究将在后续阶段进行（TBD），待模型在美国城市验证成熟后扩展。*

### 1.2 城市差异化特征捕捉

为了在统一模型中有效区分不同城市的特性，我们将重点构建以下三类特征，以替代难以实时获取的动态社会经济数据：

**1. 地理与地形特征 (Geographic Features)**
通过静态数据精确描述城市的物理环境：
*   **经纬度 (Lat/Lon)**：直接反映城市在全球的绝对位置，隐含了太阳辐射角度、气候带等信息。
*   **海拔高度 (Elevation)**：直接影响大气压力和垂直扩散条件。
*   **距海距离 (Distance to Coast)**：计算城市中心到最近海岸线的距离。这对于捕捉海洋性气候调节、海陆风循环（对污染物扩散至关重要）具有决定性作用。

**2. 历史统计特征 (Historical Statistical Features)**
利用过去一年的历史数据计算城市的“污染指纹”：
*   **年度污染基线**：计算该城市过去一年 PM2.5 的平均浓度、中位数和 95% 分位数。这反映了城市的长期背景污染水平（例如，工业城市基线通常高于旅游城市）。
*   **季节性波动强度**：计算不同季节的浓度方差，反映城市受季节变化影响的敏感度。

**3. 人口特征 (Demographic Features)**
*   **人口规模 (Population Size)**：从 `worldcities.csv` 中直接获取。人口是人类活动强度（交通流量、能源消耗、生活排放）的最直接代理变量。将人口数值进行对数变换（Log-transformation）后作为静态特征输入，有助于模型区分超大城市与中小城市的排放量级差异。

这三类特征易于从现有数据集中自动计算或获取，且能有效捕捉“为什么这个城市与那个城市不同”的核心差异。

### 1.3 社会经济特征多样性 (TBD)

*此部分标记为 **TBD (To Be Determined)**。*
*在原型验证阶段，暂不纳入详细的 GDP、产业结构、交通模式等社会经济特征。这些特征虽然有价值，但数据获取和标准化的时间成本较高。后期将视模型优化的边际收益决定是否引入。*

### 1.4 城市坐标获取

城市坐标信息从 `data/info/worldcities.csv` 文件中获取。该文件包含全球城市的经纬度坐标、城市名称、国家代码、人口等基本信息。通过筛选特定城市，提取其经纬度坐标用于后续站点匹配。

## 2. 数据源概述

本项目使用两个公开数据源进行空气质量预测。

### 2.1 NOAA Global Surface Summary of the Day (GSOD)

这是由美国国家海洋和大气管理局提供的全球每日气象数据汇总，数据来源于全球综合表面 hourly（ISH）数据集。该数据集包含全球各地气象站点的每日观测数据，主要用于获取与空气质量相关的气象因素，如温度、降水、风速等。

历史数据存储在 AWS 公开数据集 S3 存储桶中，路径格式为年份加站点编号。数据从 1929 年开始记录至今，但通常会有 3 到 6 个月的更新延迟，参考`noaa_dataset.md`。

### 2.2 OpenAQ

OpenAQ 是一个全球性的空气质量数据聚合平台，汇集了来自政府、研究机构等数百个数据源的空气质量监测数据。该平台测量并公开发布 PM2.5、PM10、臭氧、二氧化氮、二氧化硫、一氧化碳等主要污染物的浓度数据。

历史数据存储在AWS公开数据集S3存储桶中，近期数据通过 REST API 访问，需要申请 API Key 进行身份认证，可以读取环境变量 OPENAQ_API_KEY 获得这个值。API 基础地址为 https://api.openaq.org/v3，支持按地理位置搜索监测站点、获取历史测量数据等功能。参考`openaq_dataset.md`。

## 3. 数据获取

### 3.1 城市坐标获取

从 `data/info/worldcities.csv` 文件中筛选目标城市，提取城市名称、经度、纬度等字段。文件结构通常包含 city、city_ascii、lat、lng、country、iso2、iso3、population 等列。根据预设的城市列表筛选对应记录，获取精确的坐标信息。

考虑到后期站点筛选可能有些城市缺乏足够数据，所以前期可以适当多选择一些城市，便于控制数量。

### 3.2 NOAA 站点获取

NOAA 气象站点的对应关系从 `data/info/isd-history.csv` 文件中获取。该文件记录了全球气象站点的详细信息，包括站点编号、站点名称、国家代码、经纬度、海拔高度等。通过城市坐标在该文件中搜索最近的气象站点，建立城市与站点的映射关系。

### 3.3 OpenAQ 站点获取

OpenAQ 站点通过 API 接口根据城市坐标动态获取。调用 locations 端点，传入城市经纬度和搜索半径参数，返回指定范围内的所有空气质量监测站点列表。从返回结果中筛选包含目标污染物（如 PM2.5）的站点，记录站点编号和传感器编号。

### 3.4 历史数据获取

获取最近4年的完整历史数据，时间范围设定为 2022 年至 2025 年。NOAA 数据从 S3 存储桶按年份和站点编号下载 CSV 文件。OpenAQ 数据通过 sensors 端点按日期范围批量获取日均值数据。

### 3.5 社会经济特征获取 (TBD)

*此部分标记为 **TBD**。在当前原型阶段，暂不执行社会经济数据的获取和处理。*
*原计划：城市的社会经济特征数据来源于公开的国际组织和研究机构数据库...（略）*

## 4. 城市站点匹配

### 4.1 匹配策略

为每个目标城市匹配对应的气象站点和空气质量监测站点时，采用最近邻匹配策略。首先获取城市的中心坐标，然后以该坐标为圆心，在指定半径范围内搜索可用的监测站点。

搜索到多个候选站点后，按各站点的数据量降序排序，选择数据最完整的站点作为该城市的代表站点。如果某个站点缺少特定的污染物监测数据，则顺次选择下一个站点作为备选。

### 4.2 搜索半径设定

搜索半径的选择需要平衡数据代表性和数据可用性。大城市人口密集，监测站点相对较多，可以设置较小的搜索半径如 10 到 20 公里。中小城市监测站点较少，需要扩大搜索范围，建议设置为 30 到 50 公里。也可统一配置为25公里。

### 4.3 站点选择原则

选择城市代表站点时，优先考虑以下条件：数据记录完整性好、历史数据量丰富的站点；近期仍在活跃监测、有最新数据更新的站点；与城市位于同一国家或行政区域内的站点。

## 5. 数据清洗

### 5.1 单位标准化

NOAA GSOD 数据的原始单位为英制，需要转换为公制单位以保持一致性。温度从华氏度转换为摄氏度，风速从节转换为米每秒，降水量从英寸转换为毫米。

### 5.2 缺失值处理

NOAA GSOD 使用特定数值标记缺失数据，如 9999.9、999.9 等。这些标记值需要替换为空值，在后续分析中予以排除。OpenAQ 数据如出现时间断档，超过连续七天缺失的数据段不参与建模计算。

### 5.3 异常值处理

对气象数据和污染物浓度数据进行有效性检查，剔除超出合理物理范围的极端值。例如，温度超出零下 40 度到零上 50 度的数据、降水量为负数的数据等都需要特殊处理或标记为无效。

### 5.4 时间对齐

将不同来源的数据按日期进行对齐。NOAA 数据日期字段为 DATE，格式为 YYYY-MM-DD。OpenAQ 数据需要将 UTC 时间转换为本地时间，然后提取日期部分进行匹配。

## 6. 数据集构建

### 6.1 气象特征

从 NOAA GSOD 数据中提取以下气象特征：日平均温度、最高温度、最低温度、露点温度、日降水量、平均风速、海平面气压、能见度。这些特征反映了影响空气质量的主要气象因素。

### 6.2 数据时间范围

项目使用最近4年的完整历史数据进行建模。数据时间范围设定为 2022 年 1 月 1 日至 2025 年 12 月 31 日。选择该时间范围的原因如下：该时间段的数据较为完整，NOAA 和 OpenAQ 平台均有稳定更新；覆盖完整的季节周期，有利于捕捉不同季节的污染特征；与当前时间距离适中，模型预测结果具有实际参考价值。

从 OpenAQ 数据中提取 PM2.5 和 PM10 等主要污染物的日均浓度值。目标变量为 PM2.5 日均浓度，后续将根据此计算 AQI 值。

### 6.3 日期周期特征

为捕捉季节性变化模式，将日期转换为一年中的第几天，然后使用正弦和余弦函数进行周期性编码。这种编码方式可以保证跨年日期的连续性，例如 12 月 31 日和 1 月 1 日在编码空间中相近。

### 6.4 滞后特征

创建前 1 到 7 天的滞后特征，包括滞后 1 到 7 天的温度、降水和 PM2.5 浓度。这些特征用于捕捉污染物的累积效应和时序依赖关系，反映如静稳天气导致污染物累积的情况。

### 6.5 滚动统计特征

计算 PM2.5 浓度过去 7 天的滚动平均值和滚动标准差。滚动均值反映近期整体趋势，滚动标准差反映近期波动程度，两者都是重要的预测特征。

### 6.6 社会经济特征

城市的社会经济特征反映了人类活动对空气质量的影响。这些特征以城市为单位附加到每条记录中，作为模型的辅助输入。经济发展水平以人均 GDP 或人均国民总收入表示，数值进行对数变换以减少偏态。产业结构以各行业增加值占比表示，采用分类编码或嵌入向量。交通模式特征以公共交通分担率、私家车保有量、人均出行里程等表示。能源结构以清洁能源消费占比、煤炭消费占比等表示。社会经济特征在建模实验中作为可选特征组，用于验证这些因素对预测准确性的贡献。假设这些数据在所选日期内变化不大。

## 7. 数据集合并与划分

### 7.1 数据合并

根据日期和城市，将气象数据和空气质量数据进行内连接，确保两条记录日期相同且位置接近（同城）。合并后的数据集按日期升序排列，形成连续的时间序列。

### 7.2 数据集划分

为避免数据泄露，必须按时间顺序划分数据集。训练集占总数据的 70%，验证集占 15%，测试集占 15%。训练集用于模型学习，验证集用于超参数调优，测试集用于最终性能评估。一个简单的划分，就是按照时间顺序，最老的部分是训练集，次之部分是验证集，最新的数据做测试集。

## 8. 输出格式

最终数据集包含标识信息字段、气象特征字段、时间特征字段、滞后特征字段、滚动统计特征字段和目标变量字段。标识信息包括日期、城市名称和气象站点编号。目标变量包括 污染物（如PM2.5）日均浓度，由此可以计算出AQI值。
